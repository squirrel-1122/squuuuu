<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯µç‰©ç·Šæ€¥å”åŠ©</title>
    <style>
        /* ---------------- åŸºæœ¬æ¨£å¼ ---------------- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* ---------------- ä¸»å®¹å™¨ ---------------- */
        .container {
            width: 100%;
            max-width: 600px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            padding: 24px 30px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 20px;
        }

        /* ---------------- è¼¸å…¥å€åŸŸ ---------------- */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        textarea {
            width: 100%;
            height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            line-height: 1.5;
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’çˆ†å¯¬åº¦ */
            resize: vertical;
        }

        button {
            width: 100%;
            padding: 14px;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }

        button:not(:disabled):hover {
            background-color: #0056b3;
        }

        /* ---------------- è¼‰å…¥ä¸­å‹•ç•« ---------------- */
        .loader {
            display: none; /* é è¨­éš±è— */
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto 0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ---------------- çµæœé¡¯ç¤ºå€åŸŸ ---------------- */
        #results {
            margin-top: 25px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .result-card {
            display: none; /* é è¨­éš±è— */
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 15px;
        }

        .result-card h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        #advice-display {
            line-height: 1.6;
        }

        #map-link {
            display: block; /* è®“å®ƒå¯ä»¥è¢«éš±è—/é¡¯ç¤º */
            margin-top: 15px;
            padding: 12px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            background-color: #28a745;
            border-radius: 8px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        #map-link:hover {
            background-color: #218838;
        }

        /* éŒ¯èª¤è¨Šæ¯ */
        #error-message {
            display: none;
            color: #D8000C;
            background-color: #FFD2D2;
            border: 1px solid #D8000C;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            text-align: center;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>å¯µç‰©ç·Šæ€¥å”åŠ© AI</h1>
        
        <div class="form-group">
            <label for="question-input">æ‚¨çš„å¯µç‰©ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿ</label>
            <textarea id="question-input" rows="4" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç‹—ç‹—å‰›å‰›è¢«è»Šæ’åˆ°ï¼Œè…¿åœ¨æµè¡€..."></textarea>
        </div>
        
        <button id="submit-btn">å–å¾—å”åŠ©</button>

        <div class="loader" id="loader"></div>
        
        <div id="error-message"></div>

        <div id="results">
            <div class="result-card" id="advice-card">
                <h3>ğŸ’¡ AI è™•ç†å»ºè­°</h3>
                <p id="advice-display"></p>
                <a id="map-link" href="#" target="_blank" style="display: none;">é–‹å•Ÿåœ°åœ–ï¼Œå‰å¾€æœ€è¿‘çš„é†«é™¢</a>
            </div>
        </div>
    </div>

    <script>
        // -----------------------------------------------------
        // JavaScript é‚è¼¯
        // -----------------------------------------------------

        // ç²å–é é¢ä¸Šçš„å…ƒä»¶
        const submitBtn = document.getElementById('submit-btn');
        const questionInput = document.getElementById('question-input');
        const loader = document.getElementById('loader');
        const adviceCard = document.getElementById('advice-card');
        const adviceDisplay = document.getElementById('advice-display');
        const mapLink = document.getElementById('map-link');
        const errorMessage = document.getElementById('error-message');

        // â­ï¸ Vercel API URL (ä½¿ç”¨ç›¸å°è·¯å¾‘) â­ï¸
        const API_URL = '/api/get-help'; 

        // ç¶å®šæŒ‰éˆ•é»æ“Šäº‹ä»¶
        submitBtn.addEventListener('click', handleGetHelp);

        async function handleGetHelp() {
            // 0. é‡ç½®ä»‹é¢
            setLoading(true);
            adviceCard.style.display = 'none';
            mapLink.style.display = 'none';
            errorMessage.style.display = 'none';

            // 1. ç²å–ä½¿ç”¨è€…çš„å•é¡Œ
            const question = questionInput.value;
            if (!question.trim()) {
                showError("è«‹å…ˆè¼¸å…¥æ‚¨çš„æƒ…æ³ã€‚");
                return;
            }

            try {
                // 2. ç²å– GPS ä½ç½®
                console.log("æ­£åœ¨ç²å– GPS ä½ç½®...");
                const position = await getGpsPosition();
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                console.log(`GPS ä½ç½®: ${lat}, ${lng}`);

                // 3. ç™¼é€è³‡æ–™åˆ°æ‚¨çš„ã€Œå¾Œç«¯ã€API
                console.log("æ­£åœ¨å‘¼å« Vercel API...");
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, lat, lng })
                });

                if (!response.ok) {
                    // å¦‚æœ API å›å‚³éŒ¯èª¤ (ä¾‹å¦‚ 500)
                    throw new Error(`API éŒ¯èª¤: ${response.status} ${response.statusText}`);
                }

                const data = await response.json(); // data = { advice: "...", mapUrl: "..." }
                console.log("æ”¶åˆ° AI å›æ‡‰:", data);

                // 4. åœ¨ç¶²é ä¸Šé¡¯ç¤ºçµæœ
                adviceDisplay.innerText = data.advice;
                mapLink.href = data.mapUrl;
                
                adviceCard.style.display = 'block';
                mapLink.style.display = 'block';

            } catch (error) {
                // 5. è™•ç†æ‰€æœ‰å¯èƒ½çš„éŒ¯èª¤
                console.error("è™•ç†å¤±æ•—:", error);
                if (error.code === 1) { // éŒ¯èª¤ä»£ç¢¼ 1: ä½¿ç”¨è€…æ‹’çµ• GPS
                    showError("ç„¡æ³•å–å¾—æ‚¨çš„ GPS ä½ç½®ã€‚è«‹å…è¨±ç€è¦½å™¨å­˜å–æ‚¨çš„ä½ç½®ã€‚");
                } else {
                    showError(`ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`);
                }
            } finally {
                // 6. éš±è—è¼‰å…¥ä¸­
                setLoading(false);
            }
        }

        // è¼”åŠ©åŠŸèƒ½ï¼šç²å– GPS (ä½¿ç”¨ Promise ç°¡åŒ–)
        function getGpsPosition() {
            return new Promise((resolve, reject) => {
                // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´
                if (!navigator.geolocation) {
                    reject(new Error("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ GPS å®šä½ã€‚"));
                    return;
                }
                // ç²å–ç›®å‰ä½ç½®
                navigator.geolocation.getCurrentPosition(resolve, reject);
            });
        }

        // è¼”åŠ©åŠŸèƒ½ï¼šæ§åˆ¶è¼‰å…¥ä¸­å‹•ç•«
        function setLoading(isLoading) {
            if (isLoading) {
                loader.style.display = 'block';
                submitBtn.disabled = true;
                submitBtn.innerText = 'è™•ç†ä¸­...';
            } else {
                loader.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.innerText = 'å–å¾—å”åŠ©';
            }
        }

        // è¼”åŠ©åŠŸèƒ½ï¼šé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            errorMessage.innerText = message;
            errorMessage.style.display = 'block';
            setLoading(false); // ç™¼ç”ŸéŒ¯èª¤æ™‚åœæ­¢è¼‰å…¥
        }

    </script>

</body>
</html>